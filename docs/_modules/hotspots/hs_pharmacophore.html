

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>hotspots.hs_pharmacophore &mdash; Hotspots API 1.0.2 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Hotspots API
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html#installation-notes">Installation Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html#cookbook-documentation">Cookbook Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../calculation_api.html">Hotspot Calculation API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hs_io_api.html">Hotspot IO API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../result_api.html">Result API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hs_pharmacophore_api.html">Hotspot Pharmacophore API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hs_docking_api.html">Hotspot Docking API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hs_utilities_api.html">Hotspot Utilities API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Hotspots API</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>hotspots.hs_pharmacophore</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for hotspots.hs_pharmacophore</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The :mod:`hotspots.hs_pharmacophore` module contains classes for the</span>
<span class="sd">conversion of Grid objects to pharmacophore models.</span>

<span class="sd">The main class of the :mod:`hotspots.hs_pharmacophore` module is:</span>

<span class="sd">- :class:`hotspots.hs_pharmacophore.PharmacophoreModel`</span>


<span class="sd">A Pharmacophore Model can be generated directly from a :class:`hotspots.result.Result` :</span>

<span class="sd">&gt;&gt;&gt; from hotspots.calculation import Runner</span>

<span class="sd">&gt;&gt;&gt; r = Runner()</span>
<span class="sd">&gt;&gt;&gt; result = r.from_pdb(&quot;1hcl&quot;)</span>
<span class="sd">&gt;&gt;&gt; result.get_pharmacophore_model(identifier=&quot;MyFirstPharmacophore&quot;)</span>

<span class="sd">The Pharmacophore Model can be used in Pharmit or CrossMiner</span>

<span class="sd">&gt;&gt;&gt; result.pharmacophore.write(&quot;example.cm&quot;)   # CrossMiner</span>
<span class="sd">&gt;&gt;&gt; result.pharmacophore.write(&quot;example.json&quot;)    # Pharmit</span>

<span class="sd">More information about CrossMiner is available:</span>
<span class="sd">    - Korb O, Kuhn B, hert J, Taylor N, Cole J, Groom C, Stahl M &quot;Interactive and Versatile Navigation of Structural Databases&quot; J Med Chem, 2016, 59(9):4257, [DOI: 10.1021/acs.jmedchem.5b01756]</span>

<span class="sd">More information about Pharmit is available:</span>
<span class="sd">    - Jocelyn Sunseri, David Ryan Koes; Pharmit: interactive exploration of chemical space, Nucleic Acids Research, Volume 44, Issue W1, 8 July 2016, Pages W442-W448 [DIO: 10.1093/nar/gkw287]</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">splitext</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">dirname</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ccdc</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">ccdc.descriptors</span> <span class="kn">import</span> <span class="n">GeometricDescriptors</span>
<span class="kn">from</span> <span class="nn">ccdc.molecule</span> <span class="kn">import</span> <span class="n">Atom</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">,</span> <span class="n">Coordinates</span>
<span class="kn">from</span> <span class="nn">ccdc.pharmacophore</span> <span class="kn">import</span> <span class="n">Pharmacophore</span>
<span class="kn">from</span> <span class="nn">ccdc.protein</span> <span class="kn">import</span> <span class="n">Protein</span>

<span class="kn">from</span> <span class="nn">hotspots.grid_extension</span> <span class="kn">import</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">Coordinates</span>
<span class="kn">from</span> <span class="nn">hotspots.hs_utilities</span> <span class="kn">import</span> <span class="n">Helper</span>
<span class="kn">from</span> <span class="nn">hotspots.template_strings</span> <span class="kn">import</span> <span class="n">pymol_arrow</span><span class="p">,</span> <span class="n">pymol_imports</span><span class="p">,</span> <span class="n">pymol_protein</span><span class="p">,</span> <span class="n">crossminer_features</span><span class="p">,</span> <span class="n">pymol_labels</span>
<span class="kn">from</span> <span class="nn">hotspots.wrapper_pdb</span> <span class="kn">import</span> <span class="n">Query</span><span class="p">,</span> <span class="n">PDB</span><span class="p">,</span> <span class="n">PDBResult</span>

<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span><span class="p">,</span> <span class="n">DataStructs</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">MACCSkeys</span><span class="p">,</span> <span class="n">AllChem</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_score</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">hdbscan</span>


<div class="viewcode-block" id="tanimoto_dist"><a class="viewcode-back" href="../../hs_pharmacophore_api.html#hotspots.hs_pharmacophore.tanimoto_dist">[docs]</a><span class="k">def</span> <span class="nf">tanimoto_dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate the tanimoto distance between two fingerprint arrays</span>
<span class="sd">    :param a:</span>
<span class="sd">    :param b:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dotprod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">tc</span> <span class="o">=</span> <span class="n">dotprod</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">dotprod</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">tc</span></div>


<span class="k">class</span> <span class="nc">_Ligand</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccdc_mol</span><span class="p">,</span> <span class="n">rdkit_mol</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">,</span> <span class="n">chem_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccdc_mol</span> <span class="o">=</span> <span class="n">ccdc_mol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rdmol</span> <span class="o">=</span> <span class="n">rdkit_mol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fingerprint</span> <span class="o">=</span> <span class="n">fingerprint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chemical_id</span> <span class="o">=</span> <span class="n">chem_id</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>


<span class="sd">        :param path:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ccdc_mol</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">MoleculeReader</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rdkit_mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SDMolSupplier</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganFingerprintAsBitVect</span><span class="p">(</span><span class="n">rdkit_mol</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">chem_id</span> <span class="o">=</span> <span class="n">ccdc_mol</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">return</span> <span class="n">_Ligand</span><span class="p">(</span><span class="n">ccdc_mol</span><span class="p">,</span> <span class="n">rdkit_mol</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">,</span> <span class="n">chem_id</span><span class="p">)</span>


<div class="viewcode-block" id="PharmacophoreModel"><a class="viewcode-back" href="../../hs_pharmacophore_api.html#hotspots.hs_pharmacophore.PharmacophoreModel">[docs]</a><span class="k">class</span> <span class="nc">PharmacophoreModel</span><span class="p">(</span><span class="n">Helper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to handle a Pharmacophore Model</span>

<span class="sd">    :param `hotspots.hs_pharmacophore.PharmacophoreModel.Settings` settings: Pharmacophore Model settings</span>
<span class="sd">    :param str identifier: Model identifier</span>
<span class="sd">    :param list features: list of  :class:hotspots.hs_pharmacophore._PharmacophoreFeatures</span>
<span class="sd">    :param `ccdc.protein.Protein` protein: a protein</span>
<span class="sd">    :param dict dic: key = grid identifier(interaction type), value = :class:`ccdc.utilities.Grid`</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PharmacophoreModel.Settings"><a class="viewcode-back" href="../../hs_pharmacophore_api.html#hotspots.hs_pharmacophore.PharmacophoreModel.Settings">[docs]</a>    <span class="k">class</span> <span class="nc">Settings</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        settings available for adjustment</span>

<span class="sd">        :param float feature_boundary_cutoff: The map score cutoff used to generate islands</span>
<span class="sd">        :param float max_hbond_dist: Furthest acceptable distance for a hydrogen bonding partner (from polar feature)</span>
<span class="sd">        :param float radius: Sphere radius</span>
<span class="sd">        :param bool vector_on: Include interaction vector</span>
<span class="sd">        :param float transparency: Set transparency of sphere</span>
<span class="sd">        :param bool excluded_volume:  If True, the CrossMiner pharmacophore will contain excluded volume spheres</span>
<span class="sd">        :param float binding_site_radius: Radius of search for binding site calculation, used for excluded volume</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_boundary_cutoff</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_hbond_dist</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vector_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transparency</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                     <span class="n">excluded_volume</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">binding_site_radius</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_boundary_cutoff</span> <span class="o">=</span> <span class="n">feature_boundary_cutoff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_hbond_dist</span> <span class="o">=</span> <span class="n">max_hbond_dist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_margin</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>  <span class="c1"># set more intelligently</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transparency</span> <span class="o">=</span> <span class="n">transparency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">excluded_volume</span> <span class="o">=</span> <span class="n">excluded_volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binding_site_radius</span> <span class="o">=</span> <span class="n">binding_site_radius</span>

            <span class="k">if</span> <span class="n">vector_on</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vector_on</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vector_on</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">protein</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dic</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="n">features</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projected_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;True&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;donor&quot;</span><span class="p">,</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">,</span> <span class="s2">&quot;weak_acceptor&quot;</span><span class="p">,</span> <span class="s2">&quot;weak_donor&quot;</span><span class="p">,</span> <span class="s2">&quot;aromatic&quot;</span><span class="p">],</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;negative&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">,</span> <span class="s2">&quot;apolar&quot;</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protein</span> <span class="o">=</span> <span class="n">protein</span>

        <span class="k">if</span> <span class="n">settings</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dic</span> <span class="o">=</span> <span class="n">dic</span>

    <span class="k">def</span> <span class="nf">_usr_moment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generates USR moments for shape analysis</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">hotspots.hs_utilities</span> <span class="kn">import</span> <span class="n">_generate_usr_moment</span>
            <span class="n">type_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;apolar&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;acceptor&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;donor&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;negative&quot;</span><span class="p">:</span> <span class="p">[]</span>
                        <span class="p">}</span>

            <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="n">type_dic</span><span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="p">)</span>

            <span class="n">coords_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">type_dic</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">_generate_usr_moment</span><span class="p">(</span><span class="n">fcoords_list</span><span class="o">=</span><span class="n">coords_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To use this feature you must have USR installed&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interaction features of the Pharmacophore Model</span>

<span class="sd">        :return: list of :class:`hotspots.hs_pharmacophore._PharmacophoreFeature instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span>

    <span class="k">def</span> <span class="nf">_comparision_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        converts pharmacophore into comparision dictionary</span>

<span class="sd">        :return: dic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_features</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="mi">200000</span><span class="p">,</span> <span class="n">feature_threshold</span><span class="o">=</span><span class="n">feature_threshold</span><span class="p">)</span>
        <span class="n">rank_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;apolar&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;donor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">feat</span><span class="o">.</span><span class="n">score_value</span><span class="p">:</span> <span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span><span class="p">,</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="p">,</span> <span class="n">rank_dic</span><span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span><span class="p">]]})</span>
            <span class="n">rank_dic</span><span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="PharmacophoreModel.rank_features"><a class="viewcode-back" href="../../hs_pharmacophore_api.html#hotspots.hs_pharmacophore.PharmacophoreModel.rank_features">[docs]</a>    <span class="k">def</span> <span class="nf">rank_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">feature_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">force_apolar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        orders features by score</span>

<span class="sd">        :param int max_features: maximum number of features returned</span>
<span class="sd">        :param float feature_threshold: only features above this value are considered</span>
<span class="sd">        :param force_apolar: ensures at least one point is apolar</span>
<span class="sd">        :return: list of features</span>


<span class="sd">        &gt;&gt;&gt; from hotspots.hs_io import HotspotReader</span>

<span class="sd">        &gt;&gt;&gt; result = HotspotReader(&quot;out.zip&quot;).read()</span>
<span class="sd">        &gt;&gt;&gt; model = result.get_pharmacophore_model()</span>
<span class="sd">        &gt;&gt;&gt; print(len(model.features))</span>
<span class="sd">        38</span>
<span class="sd">        &gt;&gt;&gt; model.rank_features(max_features=5)</span>
<span class="sd">        &gt;&gt;&gt; print(len(model.features))</span>
<span class="sd">        5</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">force_apolar</span><span class="p">:</span>
            <span class="n">apolar_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">feat</span><span class="o">.</span><span class="n">score_value</span><span class="p">:</span> <span class="n">feat</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span> <span class="o">==</span> <span class="s2">&quot;apolar&quot;</span><span class="p">}</span>
            <span class="n">top_apolar</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">apolar_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">apolar</span> <span class="o">=</span> <span class="n">apolar_dict</span><span class="p">[</span><span class="n">top_apolar</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">score_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">feat</span><span class="o">.</span><span class="n">score_value</span><span class="p">:</span> <span class="n">feat</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span> <span class="o">!=</span> <span class="s2">&quot;apolar&quot;</span><span class="p">}</span>
            <span class="n">sorted_scores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">score_dic</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">max_features</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">max_features</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
                <span class="n">ordered_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span> <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">sorted_scores</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">feature_threshold</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ordered_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span> <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">sorted_scores</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">feature_threshold</span><span class="p">][:</span><span class="n">max_features</span><span class="p">]</span>

            <span class="n">ordered_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apolar</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">score_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">feat</span><span class="o">.</span><span class="n">score_value</span><span class="p">:</span> <span class="n">feat</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">}</span>
            <span class="n">sorted_scores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">score_dic</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_features</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
                <span class="n">ordered_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span> <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">sorted_scores</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">feature_threshold</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ordered_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span> <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">sorted_scores</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">feature_threshold</span><span class="p">][:</span><span class="n">max_features</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="n">ordered_features</span></div>

    <span class="k">def</span> <span class="nf">_get_pymol_pharmacophore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create the pymol visualisation for a pharmacophore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pymol_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">cluster_dict = {{&quot;</span><span class="si">{0}</span><span class="s2">&quot;:[], &quot;</span><span class="si">{0}</span><span class="s2">_arrows&quot;:[]}}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
        <span class="n">sphere_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;acceptor&#39;</span><span class="p">:</span> <span class="s1">&#39;[COLOR, 1.00, 0.00, 0.00]&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;weak_acceptor&#39;</span><span class="p">:</span> <span class="s1">&#39;[COLOR, 1.00, 0.604, 0.604]&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;donor&#39;</span><span class="p">:</span> <span class="s1">&#39;[COLOR, 0.00, 0.00, 1.00]&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;weak_donor&#39;</span><span class="p">:</span> <span class="s1">&#39;[COLOR, 0.604, 0.804, 1.00]&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;apolar&#39;</span><span class="p">:</span> <span class="s1">&#39;[COLOR, 1.00, 1.000, 0.000]&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;aromatic&#39;</span><span class="p">:</span><span class="s1">&#39;[COLOR, 1.00, 0.647, 0.000]&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="s1">&#39;[COLOR, 0.5, 0.5, 0.5]&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;positive&#39;</span><span class="p">:</span> <span class="s1">&#39;[COLOR, 0.0, 1.0, 1.0]&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;negative&#39;</span><span class="p">:</span> <span class="s1">&#39;[COLOR, 0.6, 0.1, 0.6]&#39;</span>
                       <span class="p">}</span>
        <span class="n">colour_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;acceptor&#39;</span><span class="p">:</span> <span class="s1">&#39;red blue&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;weak_acceptor&#39;</span><span class="p">:</span><span class="s1">&#39;red blue&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;donor&#39;</span><span class="p">:</span> <span class="s1">&#39;blue red&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;weak_donor&#39;</span><span class="p">:</span> <span class="s1">&#39;blue red&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;apolar&#39;</span><span class="p">:</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;aromatic&#39;</span><span class="p">:</span> <span class="s1">&#39;yellow&#39;</span><span class="p">}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">:</span>
            <span class="n">pymol_out</span> <span class="o">+=</span> <span class="n">pymol_protein</span><span class="p">(</span><span class="n">zip_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s2">.pdb&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">feature_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projected_dict</span><span class="p">[</span><span class="s2">&quot;True&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                    <span class="n">feature</span><span class="o">.</span><span class="n">feature_type</span> <span class="o">!=</span> <span class="s1">&#39;aromatic&#39;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">arrow</span> <span class="o">=</span> <span class="s1">&#39;cluster_dict[&quot;</span><span class="si">{7}</span><span class="s1">_arrows&quot;] += cgo_arrow([</span><span class="si">{0}</span><span class="s1">,</span><span class="si">{1}</span><span class="s1">,</span><span class="si">{2}</span><span class="s1">], [</span><span class="si">{3}</span><span class="s1">,</span><span class="si">{4}</span><span class="s1">,</span><span class="si">{5}</span><span class="s1">], color=&quot;</span><span class="si">{6}</span><span class="s1">&quot;, name=&quot;Arrows_</span><span class="si">{7}</span><span class="s1">_</span><span class="si">{8}</span><span class="s1">&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span> \
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                            <span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                            <span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                            <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                            <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                            <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                            <span class="n">colour_dict</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_type</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">feature</span><span class="o">.</span><span class="n">feature_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projected_dict</span><span class="p">[</span><span class="s2">&quot;True&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">feature</span><span class="o">.</span><span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;aromatic&#39;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">arrow</span> <span class="o">=</span> <span class="s1">&#39;cluster_dict[&quot;</span><span class="si">{7}</span><span class="s1">_arrows&quot;] += &#39;</span> \
                        <span class="s1">&#39;[9.0, float(</span><span class="si">{0}</span><span class="s1">), float(</span><span class="si">{1}</span><span class="s1">), float(</span><span class="si">{2}</span><span class="s1">), float(</span><span class="si">{3}</span><span class="s1">), float(</span><span class="si">{4}</span><span class="s1">), float(</span><span class="si">{5}</span><span class="s1">), 0.07, 1.00, 0.647, 0.00, 1.00, 0.647, 0.00] </span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                        <span class="n">colour_dict</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_type</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arrow</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">sphere</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> + [ALPHA, </span><span class="si">{1}</span><span class="s1">] + [SPHERE, float(</span><span class="si">{2}</span><span class="s1">), float(</span><span class="si">{3}</span><span class="s1">), float(</span><span class="si">{4}</span><span class="s1">), float(</span><span class="si">{5}</span><span class="s1">)]</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sphere_dict</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_type</span><span class="p">],</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">transparency</span><span class="p">,</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                        <span class="n">feature</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>

            <span class="n">pymol_out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cluster_dict[&quot;</span><span class="si">{0}</span><span class="s1">&quot;] += </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">sphere</span><span class="p">)</span>
            <span class="n">pymol_out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">projected_identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein</span> <span class="ow">and</span> <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># arpeggio format</span>
                <span class="n">pymol_out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cmd.select(&quot;a&quot;, &quot;resi </span><span class="si">{</span><span class="n">feature</span><span class="o">.</span><span class="n">projected_identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
                <span class="n">pymol_out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cmd.show(&quot;sticks&quot;, &quot;a&quot;)&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">projected_identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">feature</span><span class="o">.</span><span class="n">projected_coordinates</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># ccdc format</span>
                <span class="n">pymol_out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cmd.select(&quot;a&quot;, &quot;resi </span><span class="si">{</span><span class="n">feature</span><span class="o">.</span><span class="n">projected_identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">:]</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
                <span class="n">pymol_out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cmd.show(&quot;sticks&quot;, &quot;a&quot;)&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">projected_identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span>

        <span class="n">pymol_out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cmd.load_cgo(cluster_dict[&quot;</span><span class="si">{0}</span><span class="s1">&quot;], &quot;Features_</span><span class="si">{0}</span><span class="s1">&quot;, 1)&#39;</span> \
                     <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cmd.load_cgo(cluster_dict[&quot;</span><span class="si">{0}</span><span class="s1">_arrows&quot;], &quot;Arrows_</span><span class="si">{0}</span><span class="s1">&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
        <span class="n">pymol_out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cmd.set(&quot;transparency&quot;, 0.2,&quot;Features_</span><span class="si">{0}</span><span class="s1">&quot;)&#39;</span> \
                     <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cmd.group(&quot;Pharmacophore_</span><span class="si">{0}</span><span class="s1">&quot;, members=&quot;Features_</span><span class="si">{0}</span><span class="s1">&quot;)&#39;</span> \
                     <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cmd.group(&quot;Pharmacophore_</span><span class="si">{0}</span><span class="s1">&quot;, members=&quot;Arrows_</span><span class="si">{0}</span><span class="s1">&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

        <span class="n">pymol_out</span> <span class="o">+=</span> <span class="n">pymol_labels</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">lfile</span><span class="p">,</span>
                                  <span class="n">objname</span><span class="o">=</span><span class="s2">&quot;label_threshold_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span>

        <span class="n">pymol_out</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">cmd.group(&#39;Pharmacophore_</span><span class="si">{0}</span><span class="s2">&#39;, members= &#39;label_threshold_</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pymol_out</span>

    <span class="k">def</span> <span class="nf">_as_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns _features as grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filtered_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">filtered_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span> <span class="o">==</span> <span class="n">feature_type</span><span class="p">]</span>

        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">filtered_features</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">filtered_features</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">filtered_features</span><span class="p">]</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">tolerance</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">tolerance</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">tolerance</span><span class="p">]</span>
        <span class="n">far_corner</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">]</span>
        <span class="n">grd</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">far_corner</span><span class="o">=</span><span class="n">far_corner</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">filtered_features</span><span class="p">:</span>
            <span class="n">grd</span><span class="o">.</span><span class="n">set_sphere</span><span class="p">(</span><span class="n">point</span><span class="o">=</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scaling</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grd</span>

    <span class="k">def</span> <span class="nf">_get_binding_site_residues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return a protein binding site</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span> <span class="o">==</span> <span class="s2">&quot;apolar&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">prot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein</span>

        <span class="n">bs</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">BindingSiteFromPoint</span><span class="p">(</span><span class="n">protein</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span>
                                       <span class="n">origin</span><span class="o">=</span><span class="n">centroid</span><span class="p">,</span>
                                       <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binding_site_radius</span><span class="p">)</span>

        <span class="n">bs_residues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">bs</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="n">protein_residues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prot</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="n">deletes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">protein_residues</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">bs_residues</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">delete</span> <span class="ow">in</span> <span class="n">deletes</span><span class="p">:</span>
            <span class="n">prot</span><span class="o">.</span><span class="n">remove_residue</span><span class="p">(</span><span class="n">delete</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">prot</span>

    <span class="k">def</span> <span class="nf">_get_crossminer_pharmacophore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert a PharmacophoreModel into a crossminer pharmacophore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: UPDATE WITH CHARGED FEATURES</span>
        <span class="n">supported_features</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;acceptor_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;donor_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;donor&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;ring&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">read_feature_definitions</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;/local/pcurran/CCDC/CSD_CrossMiner/feature_definitions&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Crossminer is only available to CSD-Discovery&quot;</span><span class="p">)</span>

        <span class="n">feature_definitions</span> <span class="o">=</span> <span class="p">{</span><span class="n">supported_features</span><span class="p">[</span><span class="n">fd</span><span class="o">.</span><span class="n">identifier</span><span class="p">]:</span> <span class="n">fd</span> <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span>
                               <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">feature_definitions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                               <span class="k">if</span> <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="ow">in</span> <span class="n">supported_features</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="n">model_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span> <span class="ow">or</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Charged feature not currently supported in CrossMiner: Its on the TODO list&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">sphere</span> <span class="o">=</span> <span class="n">GeometricDescriptors</span><span class="o">.</span><span class="n">Sphere</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">projected_coordinates</span><span class="p">:</span>
                    <span class="n">projected</span> <span class="o">=</span> <span class="n">GeometricDescriptors</span><span class="o">.</span><span class="n">Sphere</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">projected_coordinates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">feature_definitions</span><span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span><span class="p">],</span> <span class="o">*</span><span class="p">[</span><span class="n">sphere</span><span class="p">,</span> <span class="n">projected</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">feature_definitions</span><span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span><span class="p">],</span> <span class="n">sphere</span><span class="p">)</span>

                <span class="n">model_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">excluded_volume</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pharmacophore Model must have protein to calculate excluded volume&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_binding_site_residues</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">bs</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
                    <span class="n">mol</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;temp_residue&quot;</span><span class="p">)</span>

                    <span class="c1"># for a in residue.backbone_atoms:</span>
                    <span class="c1">#     ev = Pharmacophore.ExcludedVolume(GeometricDescriptors.Sphere(a.coordinates, 2))</span>
                    <span class="c1">#     model_features.append(ev)</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">backbone_atoms</span><span class="p">:</span>
                        <span class="n">mol</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

                    <span class="n">centre</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">centre_of_geometry</span><span class="p">()</span>
                    <span class="n">ev</span> <span class="o">=</span> <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">ExcludedVolume</span><span class="p">(</span><span class="n">GeometricDescriptors</span><span class="o">.</span><span class="n">Sphere</span><span class="p">(</span><span class="n">centre</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">model_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">Query</span><span class="p">(</span><span class="n">model_features</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_run_query</span><span class="p">(</span><span class="n">accession_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        search the PDB for entries which have the same UniProt code, contain ligands and are</span>
<span class="sd">        within a resolution cutoff</span>

<span class="sd">        :param str accession_id: the accession ID for the target</span>
<span class="sd">        :return list: list of :class:`pdb_python_api.PDBResult` instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create query</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span>
        <span class="n">q</span><span class="o">.</span><span class="n">add_term</span><span class="p">(</span><span class="n">query_type</span><span class="o">=</span><span class="s2">&quot;UpAccessionIdQuery&quot;</span><span class="p">,</span>
                   <span class="n">query_parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;accessionIdList&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">accession_id</span><span class="p">)})</span>

        <span class="n">q</span><span class="o">.</span><span class="n">add_term</span><span class="p">(</span><span class="n">query_type</span><span class="o">=</span><span class="s2">&quot;NoLigandQuery&quot;</span><span class="p">,</span>
                   <span class="n">query_parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;haveLigands&#39;</span><span class="p">:</span> <span class="s1">&#39;yes&#39;</span><span class="p">},</span>
                   <span class="n">conjunction</span><span class="o">=</span><span class="s1">&#39;and&#39;</span><span class="p">)</span>

        <span class="n">q</span><span class="o">.</span><span class="n">add_term</span><span class="p">(</span><span class="n">query_type</span><span class="o">=</span><span class="s2">&quot;ResolutionQuery&quot;</span><span class="p">,</span>
                   <span class="n">query_parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;refine.ls_d_res_high.comparator&#39;</span><span class="p">:</span> <span class="s1">&#39;between&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;refine.ls_d_res_high.min&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;refine.ls_d_res_high.max&#39;</span><span class="p">:</span> <span class="s1">&#39;2.5&#39;</span><span class="p">},</span>
                   <span class="n">conjunction</span><span class="o">=</span><span class="s1">&#39;and&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PDB</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_ligands</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        smiles to RDKit molecule</span>

<span class="sd">        :param list: list of :class:`pdb_python_api.PDBResult` instances</span>
<span class="sd">        :return: RDKit molecules</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ligs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">uniques</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">filtered_ligands</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">rdmol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>
                    <span class="n">AllChem</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">rdmol</span><span class="p">)</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">rdmol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;_Name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">identifier</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">l</span><span class="o">.</span><span class="n">chemical_id</span><span class="p">))</span>
                    <span class="c1"># l.fingerprint = MACCSkeys.GenMACCSKeys(l.rdmol)</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">fingerprint</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganFingerprintAsBitVect</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">rdmol</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">chemical_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uniques</span><span class="p">:</span>
                        <span class="n">ligs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                        <span class="n">uniques</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">chemical_id</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">ligs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_cluster_ligands</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">fingerprint_array</span><span class="p">(</span><span class="n">ligands</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,))</span>
                <span class="n">DataStructs</span><span class="o">.</span><span class="n">ConvertToNumpyArray</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">fingerprint</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">X</span>

        <span class="n">cluster_dic</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># generate fingerprint array</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">fingerprint_array</span><span class="p">(</span><span class="n">ligands</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">fingerprint_array</span><span class="p">(</span><span class="n">ligands</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fingerprint array must contain more than 1 entry&quot;</span><span class="p">)</span>

        <span class="c1"># dimensionality reduction</span>
        <span class="n">tsne_X</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">tanimoto_dist</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

        <span class="c1"># clustering</span>
        <span class="n">cluster_tsne</span> <span class="o">=</span> <span class="n">hdbscan</span><span class="o">.</span><span class="n">HDBSCAN</span><span class="p">(</span><span class="n">min_cluster_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">gen_min_span_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cluster_tsne</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tsne_X</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_tsne</span><span class="o">.</span><span class="n">labels_</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">cluster_dic</span><span class="p">:</span>
                    <span class="n">cluster_dic</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ligands</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cluster_dic</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">label</span><span class="p">:</span> <span class="p">[</span><span class="n">ligands</span><span class="p">[</span><span class="n">i</span><span class="p">]]})</span>

        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">tsne_X</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_tsne</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">tsne_X</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_tsne</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_tsne</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">seen</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_tsne</span><span class="o">.</span><span class="n">labels_</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tsne_X</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
                <span class="n">sy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tsne_X</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> clusters&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_dic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NO CLUSTERS FOUND&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unique</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
                    <span class="n">hetid</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">chemical_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hetid</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">:</span>
                        <span class="n">unique</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">hetid</span><span class="p">:</span> <span class="n">l</span><span class="p">})</span>

                <span class="n">ligands</span> <span class="o">=</span> <span class="n">unique</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="n">cluster_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[</span><span class="n">ligands</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligands</span><span class="p">))}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">cluster_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[</span><span class="n">ligands</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligands</span><span class="p">))}</span>

        <span class="k">return</span> <span class="n">cluster_dic</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_align_proteins</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">reference_chain</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        align proteins by chain</span>

<span class="sd">        :param `ccdc.protein.Protein` reference: align to me</span>
<span class="sd">        :param str reference_chain: align to this chain</span>
<span class="sd">        :param list targets: list of `ccdc.protein.Protein`</span>
<span class="sd">        :return tup: list(:class:`ccdc.protein.Protein`) and list (:classa`ccdc.molecule.Molecule`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aligning proteins to </span><span class="si">{}</span><span class="s2">, chain </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">reference_chain</span><span class="p">))</span>
        <span class="n">aligned_prots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aligned_ligands</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">reference</span> <span class="o">=</span> <span class="n">Protein</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">reference</span><span class="o">.</span><span class="n">add_hydrogens</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
            <span class="n">prot</span> <span class="o">=</span> <span class="n">Protein</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">prot</span><span class="o">.</span><span class="n">detect_ligand_bonds</span><span class="p">()</span>
            <span class="n">prot</span><span class="o">.</span><span class="n">add_hydrogens</span><span class="p">()</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">prot</span><span class="o">.</span><span class="n">ligands</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">clustered_ligand</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">bs</span> <span class="o">=</span> <span class="n">Protein</span><span class="o">.</span><span class="n">BindingSiteFromMolecule</span><span class="p">(</span><span class="n">protein</span><span class="o">=</span><span class="n">prot</span><span class="p">,</span>
                                                             <span class="n">molecule</span><span class="o">=</span><span class="n">l</span><span class="p">,</span>
                                                             <span class="n">distance</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
                        <span class="n">chain</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">chain</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">chain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        </span><span class="si">{}</span><span class="s2"> failed! No chain detected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">binding_site_superposition</span> <span class="o">=</span> <span class="n">Protein</span><span class="o">.</span><span class="n">ChainSuperposition</span><span class="p">()</span>
                <span class="p">(</span><span class="n">bs_rmsd</span><span class="p">,</span> <span class="n">bs_transformation</span><span class="p">)</span> <span class="o">=</span> <span class="n">binding_site_superposition</span><span class="o">.</span><span class="n">superpose</span><span class="p">(</span><span class="n">reference</span><span class="p">[</span><span class="n">reference_chain</span><span class="p">],</span>
                                                                                    <span class="n">prot</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
                <span class="n">aligned_prots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">lig</span> <span class="ow">in</span> <span class="n">prot</span><span class="o">.</span><span class="n">ligands</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">clustered_ligand</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">lig</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">chain</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">lig</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">aligned_ligands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lig</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        </span><span class="si">{}</span><span class="s2"> failed!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">aligned_prots</span><span class="p">,</span> <span class="n">aligned_ligands</span>

<div class="viewcode-block" id="PharmacophoreModel.write"><a class="viewcode-back" href="../../hs_pharmacophore_api.html#hotspots.hs_pharmacophore.PharmacophoreModel.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        writes out pharmacophore. Supported formats:</span>

<span class="sd">        - &quot;.cm&quot; (*CrossMiner*),</span>
<span class="sd">        - &quot;.json&quot; (`Pharmit &lt;http://pharmit.csb.pitt.edu/search.html/&gt;`_),</span>
<span class="sd">        - &quot;.py&quot; (*PyMOL*),</span>
<span class="sd">        - &quot;.csv&quot;,</span>
<span class="sd">        - &quot;.mol2&quot;</span>

<span class="sd">        :param str fname: path to output file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.cm&quot;</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING! Charged features not currently supported in CrossMiner!&quot;</span><span class="p">)</span>
            <span class="n">pharmacophore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_crossminer_pharmacophore</span><span class="p">()</span>
            <span class="n">pharmacophore</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Identifier&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">],</span>
                               <span class="s1">&#39;Feature_type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_type</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">],</span>
                               <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">],</span>
                               <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">],</span>
                               <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">],</span>
                               <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">score_value</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">]</span>
                               <span class="p">})</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.py&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pymol_file</span><span class="p">:</span>
                <span class="n">lfile</span> <span class="o">=</span> <span class="s2">&quot;label_threshold_</span><span class="si">{}</span><span class="s2">.mol2&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

                <span class="n">pymol_out</span> <span class="o">=</span> <span class="n">pymol_imports</span><span class="p">()</span>
                <span class="n">pymol_out</span> <span class="o">+=</span> <span class="n">pymol_arrow</span><span class="p">()</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pymol_pharmacophore</span><span class="p">(</span><span class="n">lfile</span><span class="p">)</span>
                <span class="n">pymol_out</span> <span class="o">+=</span> <span class="n">lines</span>
                <span class="n">pymol_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pymol_out</span><span class="p">)</span>

            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">MoleculeWriter</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">lfile</span><span class="p">))</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">MoleculeWriter</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s2">.pdb&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pharmit_file</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">interaction_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;apolar&#39;</span><span class="p">:</span> <span class="s1">&#39;Hydrophobic&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;donor&#39;</span><span class="p">:</span> <span class="s1">&#39;HydrogenDonor&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;acceptor&#39;</span><span class="p">:</span> <span class="s1">&#39;HydrogenAcceptor&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;negative&#39;</span><span class="p">:</span> <span class="s1">&#39;NegativeIon&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;positive&#39;</span><span class="p">:</span> <span class="s1">&#39;PositiveIon&#39;</span>
                                   <span class="p">}</span>

                <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">vector</span><span class="p">:</span>
                        <span class="n">point</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">interaction_dic</span><span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span><span class="p">],</span>
                                 <span class="s2">&quot;hasvec&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                 <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                                 <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                                 <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
                                 <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="s2">&quot;vector_on&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">vector_on</span><span class="p">,</span>
                                 <span class="s2">&quot;svector&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                             <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                                             <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">z</span><span class="p">},</span>
                                 <span class="s2">&quot;minsize&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;maxsize&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;selected&quot;</span><span class="p">:</span> <span class="kc">False</span>
                                 <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">point</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">interaction_dic</span><span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span><span class="p">],</span>
                                 <span class="s2">&quot;hasvec&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                 <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                 <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                                 <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                                 <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
                                 <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="s2">&quot;vector_on&quot;</span><span class="p">:</span> <span class="n">feat</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">vector_on</span><span class="p">,</span>
                                 <span class="s2">&quot;svector&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                             <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                             <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                                 <span class="s2">&quot;minsize&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;maxsize&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;selected&quot;</span><span class="p">:</span> <span class="kc">False</span>
                                 <span class="p">}</span>
                    <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="n">pharmit_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">pts</span><span class="p">}))</span>

        <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.mol2&quot;</span><span class="p">:</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;pharmacophore_model&quot;</span><span class="p">)</span>
            <span class="n">atom_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;apolar&quot;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;aromatic&quot;</span><span class="p">:</span><span class="s1">&#39;C&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;donor&quot;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;weak_donor&quot;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;acceptor&quot;</span><span class="p">:</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;weak_acceptor&quot;</span><span class="p">:</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;negative&quot;</span><span class="p">:</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;positve&quot;</span><span class="p">:</span> <span class="s1">&#39;H&#39;</span><span class="p">}</span>

            <span class="n">pseudo_atms</span> <span class="o">=</span> <span class="p">[</span><span class="n">Atom</span><span class="p">(</span><span class="n">atomic_symbol</span><span class="o">=</span><span class="n">atom_dic</span><span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_type</span><span class="p">],</span>
                                <span class="n">atomic_number</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                                <span class="n">coordinates</span><span class="o">=</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_coordinates</span><span class="p">,</span>
                                <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">score_value</span><span class="p">))</span>
                           <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pseudo_atms</span><span class="p">:</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">MoleculeWriter</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.grd&quot;</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_grid</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;&quot;&quot;</span><span class="si">{}</span><span class="s2">&quot; output file type is not currently supported.&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extension</span><span class="p">))</span></div>

<div class="viewcode-block" id="PharmacophoreModel.from_hotspot"><a class="viewcode-back" href="../../hs_pharmacophore_api.html#hotspots.hs_pharmacophore.PharmacophoreModel.from_hotspot">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_hotspot</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;id_01&quot;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_island_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates a pharmacophore model from a Fragment Hotspot Map result</span>

<span class="sd">        (included for completeness, equivalent to `hotspots.result.Result.get_pharmacophore()`)</span>

<span class="sd">        :param `hotspots.result.Result` result: a Fragment Hotspot Maps result (or equivalent)</span>
<span class="sd">        :param str identifier: Pharmacophore Model identifier</span>
<span class="sd">        :param float threshold: values above this value</span>
<span class="sd">        :param `hotspots.hs_pharmacophore.PharmacophoreModel.Settings` settings: settings</span>

<span class="sd">        :return: :class:`hotspots.hs_pharmacophore.PharmacophoreModel`</span>

<span class="sd">        &gt;&gt;&gt; from hotspots.calculation import Runner</span>
<span class="sd">        &gt;&gt;&gt; from hotspots.hs_pharmacophore import PharmacophoreModel</span>

<span class="sd">        &gt;&gt;&gt; r = Runner()</span>
<span class="sd">        &gt;&gt;&gt; result = r.from_pdb(&quot;1hcl&quot;)</span>
<span class="sd">        &gt;&gt;&gt; model = PharmacophoreModel(result, identifier=&quot;pharmacophore&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>

        <span class="n">feature_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">probe</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">super_grids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
            <span class="n">feature_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_PharmacophoreFeature</span><span class="o">.</span><span class="n">from_hotspot</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span> <span class="n">settings</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">PharmacophoreModel</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span>
                                  <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                                  <span class="n">features</span><span class="o">=</span><span class="n">feature_list</span><span class="p">,</span>
                                  <span class="n">protein</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">protein</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_from_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">protein</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates a pharmacophore model from file (only .cm supported)</span>

<span class="sd">        :param str fname: path to CrossMiner file</span>
<span class="sd">        :param `ccdc.protein.Protein` protein: protein</span>
<span class="sd">        :param str identifier: identifier for the Pharmacophore Model</span>
<span class="sd">        :param `hotspots.hs_pharmacophore.PharmacophoreModel.Settings` settings: settings</span>

<span class="sd">        :return: :class:`hotspots.hs_pharmacophore.PharmacophoreModel`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self, projected, feature_type, feature_coordinates, projected_coordinates, score_value, vector,</span>
        <span class="c1">#                  settings)</span>
        <span class="n">cm_feature_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ring&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;ring_planar_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;ring_non_planar&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;hydrophobic&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;donor_ch_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;donor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;donor_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;donor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;donor&quot;</span><span class="p">:</span> <span class="s2">&quot;donor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;acceptor_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;acceptor&quot;</span><span class="p">:</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;negative&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;excluded_volume&quot;</span><span class="p">:</span> <span class="s2">&quot;surface&quot;</span><span class="p">,</span>
                           <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get feature information</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">Query</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">spheres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">point</span><span class="p">())</span>
            <span class="n">centre</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">spheres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">point</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">spheres</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">projected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">spheres</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">centre</span><span class="o">.</span><span class="n">point</span><span class="p">()</span>
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_PharmacophoreFeature</span><span class="p">(</span><span class="n">projected</span><span class="o">=</span><span class="n">projected</span><span class="p">,</span>
                                                      <span class="n">feature_type</span><span class="o">=</span><span class="n">cm_feature_dict</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">identifier</span><span class="p">],</span>
                                                      <span class="n">feature_coordinates</span><span class="o">=</span><span class="n">Coordinates</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                                                      <span class="nb">float</span><span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                                                      <span class="nb">float</span><span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                                                                      <span class="p">),</span>
                                                      <span class="n">projected_coordinates</span><span class="o">=</span><span class="n">Coordinates</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                                                        <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                                                        <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                                                                        <span class="p">),</span>
                                                      <span class="n">score_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                      <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                      <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">projected</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_PharmacophoreFeature</span><span class="p">(</span><span class="n">projected</span><span class="o">=</span><span class="n">projected</span><span class="p">,</span>
                                                      <span class="n">feature_type</span><span class="o">=</span><span class="n">cm_feature_dict</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">identifier</span><span class="p">],</span>
                                                      <span class="n">feature_coordinates</span><span class="o">=</span><span class="n">Coordinates</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                                                      <span class="nb">float</span><span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                                                      <span class="nb">float</span><span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                                                                      <span class="p">),</span>
                                                      <span class="n">projected_coordinates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                      <span class="n">score_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                      <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                      <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                                <span class="p">)</span>

        <span class="c1"># with open(fname) as f:</span>
        <span class="c1">#     file = f.read().split(&quot;FEATURE_LIBRARY_END&quot;)[1]</span>
        <span class="c1">#     lines = [l for l in file.split(&quot;&quot;&quot;\r\n\r\n&quot;&quot;&quot;) if l != &quot;&quot;]</span>
        <span class="c1">#     feature_list = [f for f in [_PharmacophoreFeature.from_crossminer(feature) for feature in lines] if</span>
        <span class="c1">#                     f != None]</span>

        <span class="k">return</span> <span class="n">PharmacophoreModel</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span>
                                  <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                                  <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                                  <span class="n">protein</span><span class="o">=</span><span class="n">protein</span><span class="p">)</span>

<div class="viewcode-block" id="PharmacophoreModel.from_ligands"><a class="viewcode-back" href="../../hs_pharmacophore_api.html#hotspots.hs_pharmacophore.PharmacophoreModel.from_ligands">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_ligands</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">protein</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates a Pharmacophore Model from a collection of overlaid ligands</span>

<span class="sd">        :param `ccdc,molecule.Molecule` ligands: ligands from which the Model is created</span>
<span class="sd">        :param str identifier: identifier for the Pharmacophore Model</span>
<span class="sd">        :param `ccdc.protein.Protein` protein: target system that the model has been created for</span>
<span class="sd">        :param `hotspots.hs_pharmacophore.PharmacophoreModel.Settings` settings: Pharmacophore Model settings</span>

<span class="sd">        :return: :class:`hotspots.hs_pharmacophore.PharmacophoreModel`</span>


<span class="sd">        &gt;&gt;&gt; from ccdc.io import MoleculeReader</span>
<span class="sd">        &gt;&gt;&gt; from hotspots.hs_pharmacophore import PharmacophoreModel</span>

<span class="sd">        &gt;&gt;&gt; mols = MoleculeReader(&quot;ligand_overlay_model.mol2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; model = PharmacophoreModel.from_ligands(mols, &quot;ligand_overlay_pharmacophore&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # write to .json and search in pharmit</span>
<span class="sd">        &gt;&gt;&gt; model.write(&quot;model.json&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm_dic</span> <span class="o">=</span> <span class="n">crossminer_features</span><span class="p">()</span>
        <span class="n">blank_grd</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">initalise_grid</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">coordinates</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ligands</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="n">feature_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;apolar&quot;</span><span class="p">:</span> <span class="n">blank_grd</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                       <span class="s2">&quot;acceptor&quot;</span><span class="p">:</span> <span class="n">blank_grd</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                       <span class="s2">&quot;donor&quot;</span><span class="p">:</span> <span class="n">blank_grd</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ligands</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Molecule</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">MoleculeWriter</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="s2">&quot;ligs.mol2&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">ligands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">CrystalReader</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="s2">&quot;ligs.mol2&quot;</span><span class="p">)))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">read_feature_definitions</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;/local/pcurran/CCDC/CSD_CrossMiner/feature_definitions&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Crossminer is only available to CSD-Discovery&quot;</span><span class="p">)</span>

        <span class="n">feature_definitions</span> <span class="o">=</span> <span class="p">[</span><span class="n">fd</span> <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">feature_definitions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;exit_vector&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;heavy_atom&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;hydrophobe&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;fluorine&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;bromine&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;chlorine&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;iodine&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;halogen&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;deoxyribose&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;donor_ch_projected&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;acceptor_projected&#39;</span> <span class="ow">and</span>
                               <span class="n">fd</span><span class="o">.</span><span class="n">identifier</span> <span class="o">!=</span> <span class="s1">&#39;pyrimidine&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">feature_definitions</span><span class="p">:</span>
            <span class="n">detected</span> <span class="o">=</span> <span class="p">[</span><span class="n">fd</span><span class="o">.</span><span class="n">detect_features</span><span class="p">(</span><span class="n">ligand</span><span class="p">)</span> <span class="k">for</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">]</span>
            <span class="n">all_feats</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">detected</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_feats</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_feats</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fd</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s2"> features detected&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_feats</span><span class="p">:</span>
                <span class="n">feature_dic</span><span class="p">[</span><span class="n">cm_dic</span><span class="p">[</span><span class="n">fd</span><span class="o">.</span><span class="n">identifier</span><span class="p">]]</span><span class="o">.</span><span class="n">set_sphere</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">spheres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centre</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">spheres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">projected_ident</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">projected_coordinates</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">feature_grd</span> <span class="ow">in</span> <span class="n">feature_dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">feature_grd</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">(</span><span class="n">min_distance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">projected_coordinates</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">feat</span> <span class="o">==</span> <span class="s2">&quot;donor&quot;</span> <span class="ow">or</span> <span class="n">feat</span> <span class="o">==</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">protein</span><span class="p">:</span>
                        <span class="n">projected_ident</span><span class="p">,</span> \
                        <span class="n">projected_coordinates</span> <span class="o">=</span> <span class="n">_PharmacophoreFeature</span><span class="o">.</span><span class="n">get_projected_coordinates</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span>
                                                                                                <span class="n">coords</span><span class="p">,</span>
                                                                                                <span class="n">protein</span><span class="p">,</span>
                                                                                                <span class="n">settings</span><span class="p">)</span>

                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_PharmacophoreFeature</span><span class="p">(</span><span class="n">projected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                      <span class="n">feature_type</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span>
                                                      <span class="n">feature_coordinates</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
                                                      <span class="n">projected_coordinates</span><span class="o">=</span><span class="n">projected_coordinates</span><span class="p">,</span>
                                                      <span class="n">projected_identifier</span><span class="o">=</span><span class="n">projected_ident</span><span class="p">,</span>
                                                      <span class="n">score_value</span><span class="o">=</span><span class="n">feature_grd</span><span class="o">.</span><span class="n">value_at_coordinate</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span>
                                                                                                  <span class="n">position</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>

                                                      <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                      <span class="n">settings</span><span class="o">=</span><span class="n">settings</span>
                                                      <span class="p">)</span>
                                <span class="p">)</span>

        <span class="k">return</span> <span class="n">PharmacophoreModel</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span>
                                  <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                                  <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                                  <span class="n">protein</span><span class="o">=</span><span class="n">protein</span><span class="p">,</span>
                                  <span class="n">dic</span><span class="o">=</span><span class="n">feature_dic</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_to_file</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;ligands.dat&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">structure_id</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">chemical_id</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">smiles</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_from_siena</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates a Pharmacophore Model from a PDB code using a binding site search</span>

<span class="sd">        (Previously this was done through from_pdb however doing a binding site search is much cleaner)</span>

<span class="sd">        :param pdb_list:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">hotspots.siena</span> <span class="kn">import</span> <span class="n">Search</span>
        <span class="n">searcher</span> <span class="o">=</span> <span class="n">Search</span><span class="p">()</span>
        <span class="n">ensemble</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">create_ensemble</span><span class="p">(</span><span class="n">pdb_code</span><span class="o">=</span><span class="n">pdb</span><span class="p">,</span>
                                            <span class="n">ligand</span><span class="o">=</span><span class="n">ligand</span><span class="p">,</span>
                                            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">out_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="n">ensemble</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">)</span>
        <span class="n">ligands</span> <span class="o">=</span> <span class="p">[</span><span class="n">_Ligand</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;ligands&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                   <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;ligands&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sdf&quot;</span><span class="p">]</span>

        <span class="n">cluster_dict</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">_cluster_ligands</span><span class="p">(</span><span class="n">ligands</span><span class="o">=</span><span class="n">ligands</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
        <span class="n">reps</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ccdc_mol</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cluster_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">from_ligands</span><span class="p">(</span><span class="n">ligands</span><span class="o">=</span><span class="n">reps</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">representatives</span> <span class="o">=</span> <span class="n">reps</span>
        <span class="k">return</span> <span class="n">p</span>

<div class="viewcode-block" id="PharmacophoreModel.from_pdb"><a class="viewcode-back" href="../../hs_pharmacophore_api.html#hotspots.hs_pharmacophore.PharmacophoreModel.from_pdb">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_pdb</span><span class="p">(</span><span class="n">pdb_code</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">representatives</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;LigandBasedPharmacophore&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates a Pharmacophore Model from a PDB code.</span>

<span class="sd">        This method is used for the creation of Ligand-Based pharmacophores. The PDB is searched for protein-ligand</span>
<span class="sd">        complexes of the same UniProt code as the input. These PDB&#39;s are align, the ligands are clustered and density</span>
<span class="sd">        of atom types a given point is assigned to a grid.</span>

<span class="sd">        :param str pdb_code: single PDB code from the target system</span>
<span class="sd">        :param str chain: chain of interest</span>
<span class="sd">        :param str out_dir: path to output directory</span>
<span class="sd">        :param representatives: path to .dat file containing previously clustered data (time saver)</span>
<span class="sd">        :param str identifier: identifier for the Pharmacophore Model</span>

<span class="sd">        :return: :class:`hotspots.hs_pharmacophore.PharmacophoreModel`</span>


<span class="sd">        &gt;&gt;&gt; from hotspots.hs_pharmacophore import PharmacophoreModel</span>
<span class="sd">        &gt;&gt;&gt; from hotspots.result import Results</span>
<span class="sd">        &gt;&gt;&gt; from hotspots.hs_io import HotspotWriter</span>
<span class="sd">        &gt;&gt;&gt; from ccdc.protein import Protein</span>
<span class="sd">        &gt;&gt;&gt; from pdb_python_api import PDBResult</span>


<span class="sd">        &gt;&gt;&gt; # get the PDB ligand-based Pharmacophore for CDK2</span>
<span class="sd">        &gt;&gt;&gt; model = PharmacophoreModel.from_pdb(&quot;1hcl&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # the models grid data is stored as PharmacophoreModel.dic</span>
<span class="sd">        &gt;&gt;&gt; # download the PDB file and create a Results</span>
<span class="sd">        &gt;&gt;&gt; PDBResult(&quot;1hcl&quot;).download(&lt;output_directory&gt;)</span>
<span class="sd">        &gt;&gt;&gt; result = Result(protein=Protein.from_file(&quot;&lt;output_directory&gt;/1hcl.pdb&quot;), super_grids=model.dic)</span>
<span class="sd">        &gt;&gt;&gt; with HotspotWriter(&quot;&lt;output_directory&gt;&quot;) as w:</span>
<span class="sd">        &gt;&gt;&gt;     w.write(result)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">PDBResult</span><span class="p">(</span><span class="n">pdb_code</span><span class="p">)</span>
        <span class="n">ref</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">out_dir</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">all_ligands</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">representatives</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading representative PDB codes ...&quot;</span><span class="p">)</span>
            <span class="n">reps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">representatives</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                <span class="n">pdb_code</span><span class="p">,</span> <span class="n">hetid</span><span class="p">,</span> <span class="n">smiles</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">reps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pdb_code</span><span class="p">,</span> <span class="n">hetid</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">accession_id</span> <span class="o">=</span> <span class="n">PDBResult</span><span class="p">(</span><span class="n">pdb_code</span><span class="p">)</span><span class="o">.</span><span class="n">protein</span><span class="o">.</span><span class="n">sub_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">accession_id</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">_run_query</span><span class="p">(</span><span class="n">accession_id</span><span class="p">)</span>
            <span class="c1"># return all_ligands</span>
            <span class="n">all_ligands</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">_get_ligands</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

            <span class="n">cluster_dict</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">_cluster_ligands</span><span class="p">(</span><span class="n">ligands</span><span class="o">=</span><span class="n">all_ligands</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">reps</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cluster_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">reps</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">PDBResult</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">rep</span><span class="o">.</span><span class="n">structure_id</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">clustered_ligand</span> <span class="o">=</span> <span class="n">rep</span><span class="o">.</span><span class="n">chemical_id</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">PDBResult</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">rep</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">clustered_ligand</span> <span class="o">=</span> <span class="n">rep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span>

            <span class="n">r</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">out_dir</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="n">prots</span><span class="p">,</span> <span class="n">ligands</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">_align_proteins</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
                                                            <span class="n">reference_chain</span><span class="o">=</span><span class="n">chain</span><span class="p">,</span>
                                                            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">from_ligands</span><span class="p">(</span><span class="n">ligands</span><span class="o">=</span><span class="n">ligands</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">all_ligands</span> <span class="o">=</span> <span class="n">all_ligands</span>
        <span class="n">p</span><span class="o">.</span><span class="n">representatives</span> <span class="o">=</span> <span class="n">reps</span>
        <span class="n">p</span><span class="o">.</span><span class="n">aligned_ligands</span> <span class="o">=</span> <span class="n">ligands</span>

        <span class="k">return</span> <span class="n">p</span></div></div>


<span class="k">class</span> <span class="nc">_PharmacophoreFeature</span><span class="p">(</span><span class="n">Helper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to construct pharmacophoric models based upon fragment hotspot maps.</span>

<span class="sd">    :param projected:</span>
<span class="sd">    :param feature_type:</span>
<span class="sd">    :param feature_coordinates:</span>
<span class="sd">    :param projected_coordinates:</span>
<span class="sd">    :param score_value:</span>
<span class="sd">    :param vector:</span>
<span class="sd">    :param settings:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projected</span><span class="p">,</span> <span class="n">feature_type</span><span class="p">,</span> <span class="n">feature_coordinates</span><span class="p">,</span> <span class="n">projected_coordinates</span><span class="p">,</span> <span class="n">projected_identifier</span><span class="p">,</span>
                 <span class="n">score_value</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_projected</span> <span class="o">=</span> <span class="n">projected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_type</span> <span class="o">=</span> <span class="n">feature_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_coordinates</span> <span class="o">=</span> <span class="n">feature_coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_projected_coordinates</span> <span class="o">=</span> <span class="n">projected_coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_projected_identifier</span> <span class="o">=</span> <span class="n">projected_identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_score_value</span> <span class="o">=</span> <span class="n">score_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vector</span> <span class="o">=</span> <span class="n">vector</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>

        <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s2">&quot;donor&quot;</span> <span class="ow">or</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">vector_on</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projected</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">feature_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">feature_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_coordinates</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projected_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projected_coordinates</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projected_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projected_identifier</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">score_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_hotspot</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create a feature from a hotspot island</span>

<span class="sd">        :param `ccdc.utilities.Grid`grid: input grid</span>
<span class="sd">        :param str probe: probe type identifier</span>
<span class="sd">        :param `ccdc.protein.Protein` protein: target protein</span>
<span class="sd">        :param `hotspots.hs_pharmacophore.PharmacophoreModel.Settings` settings: settings</span>
<span class="sd">        :return: :class:`hotspots.hs_pharmacophore._PharmacophoreFeature`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">feature_type</span> <span class="o">=</span> <span class="n">probe</span>

        <span class="k">if</span> <span class="n">probe</span> <span class="o">==</span> <span class="s2">&quot;donor&quot;</span> <span class="ow">or</span> <span class="n">probe</span> <span class="o">==</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">:</span>
            <span class="n">temp_g</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">temp_g</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">(</span><span class="n">min_distance</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">feats</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">projected_identifier</span><span class="p">,</span> \
                    <span class="n">projected_coordinates</span> <span class="o">=</span> <span class="n">_PharmacophoreFeature</span><span class="o">.</span><span class="n">get_projected_coordinates</span><span class="p">(</span><span class="n">feature_type</span><span class="p">,</span>
                                                                                            <span class="n">Coordinates</span><span class="p">(</span>
                                                                                                <span class="n">x</span><span class="o">=</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                                                <span class="n">y</span><span class="o">=</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                                                <span class="n">z</span><span class="o">=</span><span class="n">peak</span><span class="p">[</span>
                                                                                                    <span class="mi">2</span><span class="p">]),</span>
                                                                                            <span class="n">protein</span><span class="p">,</span>
                                                                                            <span class="n">settings</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">projected_identifier</span><span class="p">,</span> <span class="n">projected_coordinates</span><span class="p">)</span>
                    <span class="n">feats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_PharmacophoreFeature</span><span class="p">(</span><span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                       <span class="n">feature_type</span><span class="o">=</span><span class="n">feature_type</span><span class="p">,</span>
                                                       <span class="n">feature_coordinates</span><span class="o">=</span><span class="n">Coordinates</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">peak</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                                       <span class="n">projected_identifier</span><span class="o">=</span><span class="n">projected_identifier</span><span class="p">,</span>
                                                       <span class="n">projected_coordinates</span><span class="o">=</span><span class="n">projected_coordinates</span><span class="p">,</span>
                                                       <span class="n">score_value</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">value_at_point</span><span class="p">(</span><span class="n">peak</span><span class="p">),</span>
                                                       <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                       <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                                 <span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_g</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">temp_g</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">(</span><span class="n">min_distance</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="p">[</span><span class="n">_PharmacophoreFeature</span><span class="p">(</span><span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">feature_type</span><span class="o">=</span><span class="n">feature_type</span><span class="p">,</span>
                                           <span class="n">feature_coordinates</span><span class="o">=</span><span class="n">Coordinates</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">peak</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                           <span class="n">projected_identifier</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;apolar:</span><span class="si">{</span><span class="n">grid</span><span class="o">.</span><span class="n">value_at_point</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                           <span class="n">projected_coordinates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">score_value</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">value_at_point</span><span class="p">(</span><span class="n">peak</span><span class="p">),</span>
                                           <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">feats</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_crossminer</span><span class="p">(</span><span class="n">feature_str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create feature from CrossMiner string</span>

<span class="sd">        :param str feature_str: extracted string from CrossMiner file</span>
<span class="sd">        :return: :class:`hotspots.hs_pharmacophore._PharmacophoreFeature`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm_feature_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ring&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;ring_planar_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;ring_non_planar&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;hydrophobic&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;donor_ch_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;donor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;donor_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;donor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;donor&quot;</span><span class="p">:</span> <span class="s2">&quot;donor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;acceptor_projected&quot;</span><span class="p">:</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;acceptor&quot;</span><span class="p">:</span> <span class="s2">&quot;acceptor&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;negative&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                           <span class="p">}</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">PharmacophoreModel</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>

        <span class="n">feat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;PHARMACOPHORE_FEATURE (.+?)\r&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">feature_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;excluded_volume&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_type</span> <span class="o">=</span> <span class="n">cm_feature_dict</span><span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>

            <span class="n">spher</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;PHARMACOPHORE_SPHERE (.+?)</span><span class="se">\r</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">feature_str</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">spher</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spher</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">spher</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">feature_coordinates</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">projected</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">projected_coordinates</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">spher</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">spher</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">spher</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">feature_coordinates</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">projected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">projected_coordinates</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;feature format not recognised&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_PharmacophoreFeature</span><span class="p">(</span><span class="n">projected</span><span class="p">,</span> <span class="n">feature_type</span><span class="p">,</span> <span class="n">feature_coordinates</span><span class="p">,</span> <span class="n">projected_coordinates</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span>
                                         <span class="n">vector</span><span class="p">,</span>
                                         <span class="n">settings</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_vector</span><span class="p">(</span><span class="n">projected_coordinates</span><span class="p">,</span> <span class="n">feature_coordinates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generates vector to hydrogen bonding partner on a protein.</span>
<span class="sd">        :return: Coordinates (named tuple)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Coordinates</span><span class="p">(</span><span class="n">projected_coordinates</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">feature_coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                           <span class="n">projected_coordinates</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">feature_coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                           <span class="n">projected_coordinates</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">feature_coordinates</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_projected_coordinates</span><span class="p">(</span><span class="n">feature_type</span><span class="p">,</span> <span class="n">feature_coordinates</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for a given polar feature, the nearest h-bonding partner on the protein is located.</span>
<span class="sd">        :param protein: a :class:`ccdc.protein.Protein` instance</span>
<span class="sd">        :return: feature_coordinates for hydrogen-bonding partner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_crystal</span><span class="p">(</span><span class="n">protein</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
            <span class="n">ppath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;crystal.pdb&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">MoleculeWriter</span><span class="p">(</span><span class="n">ppath</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">CrystalReader</span><span class="p">(</span><span class="n">ppath</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">crystal</span> <span class="o">=</span> <span class="n">get_crystal</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>

        <span class="n">coord_atom_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">a</span>
                           <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">protein</span><span class="o">.</span><span class="n">atoms</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;donor&#39;</span><span class="p">:</span>
            <span class="n">feature_definitions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">feature_definitions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                   <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;acceptor_projected&quot;</span><span class="p">]</span>

            <span class="c1">#</span>
            <span class="c1">#</span>
            <span class="c1"># atms = {f&quot;{r.identifier.split(&#39;:&#39;)[1]}:{a.label}&quot;: a</span>
            <span class="c1">#         for r in protein.residues for a in r.atoms if a.is_acceptor}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_definitions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Pharmacophore</span><span class="o">.</span><span class="n">feature_definitions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                   <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;donor_projected&quot;</span>
                                   <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;donor_ch_projected&quot;</span><span class="p">]</span>
            <span class="c1"># atms = {f&quot;{r.identifier.split(&#39;:&#39;)[1]}:{a.label}&quot;: a</span>
            <span class="c1">#         for r in protein.residues for a in r.atoms if a.is_donor}</span>

        <span class="n">detected_features</span> <span class="o">=</span> <span class="p">{</span><span class="n">fd</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span> <span class="n">fd</span><span class="o">.</span><span class="n">detect_features</span><span class="p">(</span><span class="n">crystal</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">feature_definitions</span><span class="p">}</span>

        <span class="n">near_atoms_coords</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">near_atoms_ident</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">ident</span><span class="p">,</span> <span class="n">atm</span> <span class="ow">in</span> <span class="n">atms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">Helper</span><span class="o">.</span><span class="n">get_distance</span><span class="p">(</span><span class="n">atm</span><span class="o">.</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">feature_coordinates</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">max_hbond_dist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">near_atoms_coords</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">near_atoms_coords</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atm</span><span class="p">)</span>
                    <span class="n">near_atoms_ident</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">near_atoms_coords</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dist</span><span class="p">:</span> <span class="p">[</span><span class="n">atm</span><span class="p">]})</span>
                    <span class="n">near_atoms_ident</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dist</span><span class="p">:</span> <span class="p">[</span><span class="n">ident</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">near_atoms_coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">closest</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">near_atoms_coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">select_atom</span> <span class="o">=</span> <span class="n">near_atoms_coords</span><span class="p">[</span><span class="n">closest</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">select_identifier</span> <span class="o">=</span> <span class="n">near_atoms_ident</span><span class="p">[</span><span class="n">closest</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">select_identifier</span><span class="p">,</span> <span class="n">select_atom</span><span class="o">.</span><span class="n">coordinates</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_maxima</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        given a grid will return the max point</span>
<span class="sd">        :param grid:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">extrema</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">max_value</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">indices_at_value</span><span class="p">(</span><span class="n">max_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">indices_to_point</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">max_value</span><span class="p">,</span> <span class="n">Coordinates</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">indices_to_point</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)),</span>
                                           <span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)),</span>
                                           <span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
                                           <span class="p">)</span>
            <span class="k">return</span> <span class="n">max_value</span><span class="p">,</span> <span class="n">Coordinates</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_centroid</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        given a grid will return the centre of mass(mass ==HS score) and the score at that point</span>
<span class="sd">        :return: score, float, and coords, ccdc.molecule.Coordinate</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">weighted_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">weighted_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">weighted_z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">nsteps</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
                    <span class="n">grid_val</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">indices_to_point</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">weighted_x</span> <span class="o">+=</span> <span class="n">grid_val</span> <span class="o">*</span> <span class="n">x</span>
                    <span class="n">weighted_y</span> <span class="o">+=</span> <span class="n">grid_val</span> <span class="o">*</span> <span class="n">y</span>
                    <span class="n">weighted_z</span> <span class="o">+=</span> <span class="n">grid_val</span> <span class="o">*</span> <span class="n">z</span>
                    <span class="n">total_mass</span> <span class="o">+=</span> <span class="n">grid_val</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">weighted_x</span><span class="p">,</span> <span class="n">total_mass</span><span class="p">),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">weighted_y</span><span class="p">,</span> <span class="n">total_mass</span><span class="p">),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">weighted_z</span><span class="p">,</span> <span class="n">total_mass</span><span class="p">)</span>
                             <span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">value_at_point</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="n">coords</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Chris Radoux, Peter Curran, Mihaela D. Smilova, Richard A. Sykes, Alicia Higueruelo, Anthony Bradley, Brian D. Marsdend, David R. Spring, Tom L. Blundell, Andrew R. Leach, William R. Pitt, Jason C. Cole

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>